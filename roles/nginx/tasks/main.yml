---
  # Tasks to install and configure Nginx

- name: Install nginx
  yum:
    name: nginx
    state: present

- name: enable nginx
  service:
    name: nginx
    enabled: yes

- name: enable httpd in selinux
  shell: "semanage permissive -a httpd_t"
  when: sel_disable == false

#- name: Install python-passlib to use htpasswd module
#  yum:
#    name: python-passlib
#    state: present

#- name: Create SSL key directory
#  file:
#    path: /etc/ssl/private
#    state: directory
#    mode: 0700

#- name: Generate self-signed key and certificate pair with OpenSSL
#  command: openssl req -x509 -nodes -subj "/C=US/ST=Illinois/L=Hell/O=IT/CN=hauptj.com" -days 365 -newkey rsa:2048 -keyout /etc/ssl/private/nginx-selfsigned.key -out /etc/ssl/certs/nginx-selfsigned.crt

#- name: Generate dhparam
#  command: openssl dhparam -out /etc/ssl/certs/dhparam.pem 2048
#  notify: restart nginx

#- name: Generate password file for wp-admin directory
#  htpasswd:
#    path: /etc/nginx/conf.d/.htpasswd
#    name: "{{ htpasswd_user }}"
#    password: "{{ htpasswd_pass }}"
#    crypt_scheme: md5_crypt

- name: start nginx
  service:
    name: nginx
    state: started
  ignore_errors: true

- name: make includes, sites-available, and sites-enabled directories
  file:
    path: "{{ item }}"
    state: directory
  with_items:
    - /etc/nginx/includes
    - /etc/nginx/sites-available
    - /etc/nginx/sites-enabled

- name: Copy nginx configuration for wordpress
  template:
    src: virtualhost.conf
    dest: /etc/nginx/sites-available/virtualhost.conf

#- name: Copy nginx blacklist configuration
#  template:
#    src: blacklist.conf
#    dest: /etc/nginx/includes/blacklist.conf

- name: Copy nginx cloudflare configuration
  template:
    src: cloudflare.conf
    dest: /etc/nginx/includes/cloudflare.conf

- name: Copy nginx mime.types configuration
  template:
    src: mime.types.conf
    dest: /etc/nginx/includes/mime.types.conf

- name: Copy nginx sites-enabled.conf
  template:
    src: sites-enabled.conf
    dest: /etc/nginx/includes/sites-enabled.conf

- name: Copy ssl configuration
  template:
    src: ssl.conf
    dest: /etc/nginx/includes/ssl.conf

#- name: Link blacklist.conf to /etc/nginx/conf.d
#  file:
#    src: /etc/nginx/includes/blacklist.conf
#    dest: /etc/nginx/conf.d/_.blacklist.conf
#    state: link

- name: Link cloudflare.conf to /etc/nginx/conf.d
  file:
    src: /etc/nginx/includes/cloudflare.conf
    dest: /etc/nginx/conf.d/_.cloudflare.conf
    state: link

- name: Link mine.types.conf to /etc/mime.types.conf.d
  file:
    src: /etc/nginx/includes/mime.types.conf
    dest: /etc/nginx/conf.d/_.mime.types.conf
    state: link

- name: Link sites-enabled.conf to /etc/nginx/conf.d
  file:
    src: /etc/nginx/includes/sites-enabled.conf
    dest: /etc/nginx/conf.d/_.sites-enabled.conf
    state: link

- name: Link mime.types.conf to /etc/nginx.conf.d
  file:
    src: /etc/nginx/includes/mime.types.conf
    dest: /etc/nginx/conf.d/_.mime.types.conf
    state: link

- name: link the virtual host using full pathnames for source and target!
  file:
    src: /etc/nginx/sites-available/virtualhost.conf
    dest: /etc/nginx/sites-enabled/virtualhost.conf
    state: link
  notify:
    - restart nginx


#- name: insert firewalld rule for nginx port {{ nginx_port }}
#  firewalld:
#    port: "{{ nginx_port }}/tcp"
#    permanent: true
#    state: enabled
#    immediate: yes
#  ignore_errors: yes
